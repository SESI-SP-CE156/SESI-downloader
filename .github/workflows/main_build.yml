name: Build & Release Main

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ===================================================
  # JOB 1: BUILD (Matriz Windows e Linux)
  # ===================================================
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true # MANTIDO: Essencial para baixar os bin√°rios reais (ffmpeg/yt-dlp)

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true
      
      # --- DEPEND√äNCIAS DO LINUX ---
      - name: Install Linux Dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libsqlite3-dev libfuse2 imagemagick

      - name: Install Project Dependencies
        run: flutter pub get

      - name: Run Build Runner
        run: dart run build_runner build --delete-conflicting-outputs

      # --- BUILD LINUX ---
      - name: Build Linux
        if: matrix.os == 'ubuntu-latest'
        run: flutter build linux --release

      - name: Create AppImage (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          # 1. Baixar ferramenta de deploy
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

          # 2. Preparar estrutura AppDir
          mkdir -p AppDir/usr/bin
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/

          # 3. Criar arquivo .desktop
          cat > sesi_downloader.desktop <<EOF
          [Desktop Entry]
          Name=SESI Downloader
          Exec=sesi_downloader
          Icon=sesi_downloader
          Type=Application
          Categories=Utility;Network;
          EOF

          # 4. Configurar √çcone
          if [ -f "linux/runner/resources/application_icon.png" ]; then
            cp linux/runner/resources/application_icon.png sesi_downloader.png
          else
            wget -q -O sesi_downloader.png https://storage.googleapis.com/cms-storage-bucket/0dbfcc7a59cd1cf16282.png
          fi
          convert sesi_downloader.png -resize 256x256! sesi_downloader.png

          # 5. Gerar AppImage
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --executable AppDir/usr/bin/sesi_downloader \
            --desktop-file sesi_downloader.desktop \
            --icon-file sesi_downloader.png \
            --output appimage

          # --- ALTERA√á√ÉO AQUI: Renomear usando a vers√£o ---
          mv SESI_Downloader*.AppImage sesi_downloader-v1.0.${{ github.run_number }}-linux-x86_64.AppImage

      - name: Upload Linux Artifact
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          # Caminho atualizado com a vers√£o
          path: sesi_downloader-v1.0.${{ github.run_number }}-linux-x86_64.AppImage

      # --- BUILD WINDOWS ---
      - name: Build Windows
        if: matrix.os == 'windows-latest'
        run: flutter build windows --release

      - name: Compress Windows Build
        if: matrix.os == 'windows-latest'
        # --- ALTERA√á√ÉO AQUI: Nome do Zip com vers√£o ---
        run: |
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath sesi_downloader-v1.0.${{ github.run_number }}-windows-x86_64.zip

      - name: Upload Windows Artifact
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          # Caminho atualizado com a vers√£o
          path: sesi_downloader-v1.0.${{ github.run_number }}-windows-x86_64.zip

  # ===================================================
  # JOB 2: RELEASE
  # ===================================================
  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*-build"
          merge-multiple: true

      - name: Generate Release Info
        id: info
        run: |
          echo "VERSION=v1.0.${{ github.run_number }}" >> $GITHUB_OUTPUT
          
          echo "### üöÄ Build v1.0.${{ github.run_number }}" > release_body.md
          echo "" >> release_body.md
          echo "**Commit:** ${{ github.sha }}" >> release_body.md
          echo "üìù **Mensagem:**" >> release_body.md
          echo "${{ github.event.head_commit.message }}" >> release_body.md

      - name: Publish Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.info.outputs.VERSION }}
          name: Release ${{ steps.info.outputs.VERSION }}
          bodyFile: release_body.md
          # O * (wildcard) vai pegar qualquer arquivo que corresponda ao padr√£o,
          # garantindo que pegue os arquivos versionados corretamente.
          artifacts: "sesi_downloader-*-linux-x86_64.AppImage,sesi_downloader-*-windows-x86_64.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
